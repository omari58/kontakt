{{- if .Values.externalSecrets.enabled }}
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "kontakt.fullname" . }}
  labels:
    {{- include "kontakt.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/sync-wave: "-2"
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval | default "30s" }}
  secretStoreRef:
    name: {{ .Values.externalSecrets.secretStoreRef.name }}
    kind: {{ .Values.externalSecrets.secretStoreRef.kind | default "ClusterSecretStore" }}
  target:
    name: {{ include "kontakt.fullname" . }}
    creationPolicy: Owner
    {{- if .Values.externalSecrets.template }}
    template:
      engineVersion: v2
      data:
        {{- /* Include user-defined template entries (e.g. constructed DATABASE_URL) */}}
        {{- range $key, $val := .Values.externalSecrets.template }}
        {{ $key }}: {{ $val | quote }}
        {{- end }}
        {{- /* Pass through data keys not already covered by a template entry */}}
        {{- range $name, $secret := .Values.externalSecrets.data }}
        {{- if not (hasKey $.Values.externalSecrets.template $name) }}
        {{ $name }}: {{ printf "{{ .%s }}" $name | quote }}
        {{- end }}
        {{- end }}
    {{- end }}
  data:
    {{- range $name, $secret := .Values.externalSecrets.data }}
    - secretKey: {{ $name }}
      remoteRef:
        key: {{ $secret.vaultPath }}
        property: {{ $secret.vaultKey }}
    {{- end }}
{{- end }}
